<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Chat AI - NekoLabs API</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Tambahkan Highlight.js untuk syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Custom Scrollbar iOS Style */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.25);
        }
        
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.15) rgba(0, 0, 0, 0.05);
        }
        
        body {
            background-color: #F2F2F7;
            color: #000000;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* iOS Style Header */
        .header {
            background-color: #FFFFFF;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            height: 60px;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            text-decoration: none;
            color: #007AFF;
        }
        
        .logo-icon {
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .logo-icon i {
            color: white;
            font-size: 1rem;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
        }
        
        /* iOS Style Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #007AFF;
            color: white;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: #007AFF;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056CC;
        }
        
        .btn-secondary {
            background-color: rgba(0, 122, 255, 0.1);
            color: #007AFF;
            border: none;
        }
        
        .btn-secondary:hover {
            background-color: rgba(0, 122, 255, 0.15);
        }
        
        .btn-danger {
            background-color: #FF3B30;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #D70015;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }
        
        /* iOS Style Sidebar */
        .sidebar {
            width: 280px;
            background-color: #FFFFFF;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            border-right: 0.5px solid rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            overflow-x: hidden;
            flex-shrink: 0;
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.15) transparent;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sidebar.collapsed {
            width: 0;
            padding: 0;
            border-right: none;
            transform: translateX(-100%);
        }
        
        .sidebar::-webkit-scrollbar {
            width: 4px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.15);
            border-radius: 2px;
        }
        
        .new-chat-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 1rem;
            border: none;
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            font-size: 0.95rem;
            outline: none;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
        }
        
        .new-chat-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0, 122, 255, 0.25);
        }
        
        .new-chat-btn:active {
            transform: translateY(0);
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            margin-bottom: 1rem;
            min-height: 0;
        }
        
        /* HISTORY ITEM - SINGLE LINE WITH ELLIPSIS */
        .history-item {
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            font-size: 0.85rem;
            justify-content: space-between;
            user-select: none;
            background-color: #FFFFFF;
            border: 0.5px solid rgba(0, 0, 0, 0.05);
            position: relative;
            max-height: 40px;
            min-height: 40px;
            overflow: hidden;
        }
        
        .history-item-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            overflow: hidden;
            min-width: 0;
            height: 100%;
        }
        
        /* Marquee Animation untuk judul panjang */
        .history-item-text-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            height: 20px;
        }
        
        .history-item-text {
            position: absolute;
            white-space: nowrap;
            transition: transform 0.3s ease;
            padding-right: 8px;
            display: inline-block;
            max-width: 100%;
        }
        
        .history-item-text.static {
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            width: 100%;
        }
        
        .history-item-text.marquee {
            animation: marquee 10s linear infinite;
            animation-play-state: paused;
            padding-right: 30px;
        }
        
        @keyframes marquee {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(calc(-100% + 100px));
            }
        }
        
        .history-item:hover .history-item-text.marquee {
            animation-play-state: running;
        }
        
        .history-item:hover .history-item-text.static {
            display: none;
        }
        
        .history-item:not(:hover) .history-item-text.marquee {
            display: none;
        }
        
        .history-item:not(:hover) .history-item-text.static {
            display: block;
        }
        
        .history-item:hover {
            background-color: #F2F2F7;
        }
        
        .history-item.active {
            background-color: #E5F2FF;
            border-color: #007AFF;
        }
        
        /* TOMBOL HAPUS SAJA */
        .history-item-actions {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            z-index: 10;
        }
        
        .more-actions-btn {
            background: none;
            border: none;
            color: #8E8E93;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            outline: none;
            font-size: 0.9rem;
        }
        
        .more-actions-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: #FF3B30;
        }
        
        .history-item.active .more-actions-btn {
            background-color: rgba(0, 122, 255, 0.1);
            color: #007AFF;
        }
        
        .history-item.active .more-actions-btn:hover {
            background-color: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
        }
        
        .sidebar-footer {
            padding-top: 1rem;
            border-top: 0.5px solid rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        
        .delete-all-btn {
            width: 100%;
            padding: 12px;
            background-color: rgba(255, 59, 48, 0.1);
            color: #FF3B30;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
            outline: none;
            font-weight: 600;
        }
        
        .delete-all-btn:hover {
            background-color: rgba(255, 59, 48, 0.15);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            min-width: 0;
            background-color: #F2F2F7;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .main-content.full-width {
            margin-left: 0;
        }
        
        .welcome-section {
            padding: 1rem;
            text-align: center;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            max-width: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .welcome-title {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            font-weight: 700;
            margin-bottom: 0.75rem;
            line-height: 1.3;
            color: #000000;
            padding: 0 0.5rem;
        }
        
        .welcome-subtitle {
            font-size: clamp(0.85rem, 1.5vw, 1rem);
            color: #8E8E93;
            margin-bottom: 1.5rem;
            max-width: 100%;
            line-height: 1.5;
            padding: 0 1rem;
        }
        
        .suggestions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            width: 100%;
            max-width: 100%;
            padding: 0 0.5rem;
        }
        
        .suggestion-card {
            background-color: #FFFFFF;
            border: 0.5px solid rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            padding: 1rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            height: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .suggestion-card:hover {
            background-color: #F2F2F7;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        
        .suggestion-card:active {
            transform: translateY(0);
        }
        
        .suggestion-title {
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #000000;
        }
        
        .suggestion-desc {
            font-size: 0.8rem;
            color: #8E8E93;
            line-height: 1.4;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        /* iOS Style Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: none;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            display: flex;
            padding: 0.5rem 0;
            margin-bottom: 0.5rem;
            animation: messageAppear 0.3s ease-out;
        }
        
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            flex-shrink: 0;
            margin-top: 4px;
        }
        
        .message.user .message-avatar {
            order: 2;
            margin-right: 0;
            margin-left: 10px;
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
        }
        
        .message.ai .message-avatar {
            background: linear-gradient(135deg, #34C759 0%, #2AA44F 100%);
        }
        
        .message-content {
            max-width: 85%;
            padding: 0;
        }
        
        .message.user .message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .message-text {
            line-height: 1.5;
            font-size: 0.95rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 10px 14px;
            border-radius: 16px;
        }
        
        .message.user .message-text {
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message.ai .message-text {
            background-color: #FFFFFF;
            color: #000000;
            border: 0.5px solid rgba(0, 0, 0, 0.05);
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        /* Image message styles */
        .message-text img {
            max-width: 100%;
            border-radius: 10px;
            margin: 8px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .message-text img.generated-image {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 14px;
            transition: opacity 0.3s ease;
        }
        
        /* Skeleton Animation for Image Loading */
        .image-skeleton-container {
            position: relative;
            width: 100%;
            border-radius: 14px;
            overflow: hidden;
            background-color: #F2F2F7;
            margin: 8px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .image-skeleton {
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* Default 16:9 */
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, #F2F2F7 25%, #E5E5EA 50%, #F2F2F7 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s infinite linear;
            border-radius: 14px;
        }
        
        @keyframes skeletonShimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        /* Aspect ratio classes for skeleton */
        .skeleton-ratio-1-1 {
            padding-bottom: 100%;
        }
        
        .skeleton-ratio-3-4 {
            padding-bottom: 133.33%;
        }
        
        .skeleton-ratio-4-3 {
            padding-bottom: 75%;
        }
        
        .skeleton-ratio-16-9 {
            padding-bottom: 56.25%;
        }
        
        .skeleton-ratio-9-16 {
            padding-bottom: 177.78%;
        }
        
        .image-info {
            font-size: 0.75rem;
            color: #8E8E93;
            margin-top: 6px;
            padding: 6px 10px;
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .message-text p {
            margin-bottom: 0.5rem;
        }
        
        .message-text p:last-child {
            margin-bottom: 0;
        }
        
        /* Styling untuk kode dengan Highlight.js */
        .message-text pre {
            background-color: #1e1e1e;
            padding: 12px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 0.5rem 0;
            border: 0.5px solid rgba(0, 0, 0, 0.1);
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Courier New', monospace;
            font-size: 0.85em;
            position: relative;
        }
        
        .message-text pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            line-height: 1.5;
            display: block;
        }
        
        /* Untuk inline code */
        .message-text code:not(pre code) {
            background-color: #F2F2F7;
            padding: 2px 5px;
            border-radius: 5px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            color: #FF2D55;
        }
        
        .message-text ul, .message-text ol {
            margin-left: 1.2rem;
            margin-bottom: 0.5rem;
        }
        
        .message-text blockquote {
            border-left: 3px solid #007AFF;
            padding-left: 10px;
            margin: 0.5rem 0;
            color: #8E8E93;
            font-style: italic;
        }
        
        .message-text table {
            border-collapse: collapse;
            width: 100%;
            margin: 0.5rem 0;
            border-radius: 10px;
            overflow: hidden;
            border: 0.5px solid rgba(0, 0, 0, 0.05);
        }
        
        .message-text th, .message-text td {
            border: 0.5px solid rgba(0, 0, 0, 0.05);
            padding: 6px 10px;
            text-align: left;
            font-size: 0.9em;
        }
        
        .message-text th {
            background-color: #F2F2F7;
            font-weight: 600;
        }
        
        .message-info {
            font-size: 0.7rem;
            color: #8E8E93;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        /* iOS Style Chat Input Container - DIPERBAIKI UNTUK MOBILE */
        .chat-input-container {
            padding: 0.75rem 1rem;
            background-color: #FFFFFF;
            border-top: 0.5px solid rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            position: relative;
        }
        
        .input-wrapper {
            max-width: 768px;
            margin: 0 auto;
            position: relative;
            width: 100%;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        
        /* iOS Style Chat Input */
        .chat-input {
            flex: 1;
            padding: 10px 16px;
            border: 0.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 18px;
            background-color: #F2F2F7;
            color: #000000;
            font-size: 0.95rem;
            resize: none;
            max-height: 120px;
            min-height: 38px;
            line-height: 1.4;
            transition: all 0.2s;
            outline: none;
            font-family: inherit;
            scrollbar-width: thin;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #007AFF;
            background-color: #FFFFFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
        }
        
        /* iOS Style Send Button - Round and Fixed at Bottom */
        .send-button {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            margin-bottom: 2px;
        }
        
        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 122, 255, 0.4);
        }
        
        .send-button:active {
            transform: scale(0.95);
        }
        
        .send-button:disabled {
            background: #C7C7CC;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Image Generate Dropdown */
        .image-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .image-generate-button {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #34C759 0%, #2AA44F 100%);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
            margin-bottom: 2px;
        }
        
        .image-generate-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(52, 199, 89, 0.4);
        }
        
        .image-generate-button:active {
            transform: scale(0.95);
        }
        
        .image-generate-button:disabled {
            background: #C7C7CC;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .image-generate-button.active {
            background: linear-gradient(135deg, #FF9500 0%, #FF5E3A 100%);
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
        }
        
        .dropdown-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background-color: #FFFFFF;
            border: 0.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 6px;
            display: none;
            flex-direction: column;
            min-width: 180px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            z-index: 1000;
            margin-bottom: 8px;
            animation: dropdownAppear 0.2s ease;
        }
        
        @keyframes dropdownAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .dropdown-menu.show {
            display: flex;
        }
        
        .dropdown-item {
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            color: #000000;
            font-size: 0.9rem;
            user-select: none;
        }
        
        .dropdown-item:hover {
            background-color: #F2F2F7;
        }
        
        .dropdown-item.active {
            background-color: #E5F2FF;
            color: #007AFF;
        }
        
        .dropdown-item i {
            font-size: 0.9rem;
            width: 18px;
            text-align: center;
        }
        
        .dropdown-divider {
            height: 0.5px;
            background-color: rgba(0, 0, 0, 0.1);
            margin: 4px 0;
        }
        
        .sub-dropdown {
            position: relative;
        }
        
        .sub-dropdown-menu {
            position: absolute;
            top: 0;
            left: 100%;
            background-color: #FFFFFF;
            border: 0.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 6px;
            display: none;
            flex-direction: column;
            min-width: 150px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            z-index: 1001;
            margin-left: 4px;
        }
        
        .sub-dropdown:hover .sub-dropdown-menu {
            display: flex;
        }
        
        .dropdown-item .arrow {
            margin-left: auto;
            font-size: 0.8rem;
            opacity: 0.6;
        }
        
        .model-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: #F2F2F7;
            color: #8E8E93;
            margin-left: auto;
        }
        
        .model-badge.active {
            background-color: #E5F2FF;
            color: #007AFF;
        }
        
        .input-footer {
            display: flex;
            justify-content: center;
            margin-top: 0.6rem;
            font-size: 0.7rem;
            color: #8E8E93;
            text-align: center;
            flex-wrap: wrap;
            padding: 0 0.5rem;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 1rem 0;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #8E8E93;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .message-actions {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        
        .message-action-btn {
            background-color: transparent;
            border: none;
            color: #8E8E93;
            cursor: pointer;
            font-size: 0.7rem;
            padding: 3px 6px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
            outline: none;
        }
        
        .message-action-btn:hover {
            background-color: #F2F2F7;
            color: #007AFF;
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #8E8E93;
            font-size: 0.8rem;
        }
        
        .chat-active .welcome-section {
            display: none;
        }
        
        .chat-active .chat-messages {
            display: block;
        }
        
        /* iOS Style Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 1rem;
            backdrop-filter: blur(8px);
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: #FFFFFF;
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 480px;
            border: 0.5px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: modalAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-title {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: #000000;
        }
        
        .modal-body {
            margin-bottom: 1.25rem;
            color: #8E8E93;
            line-height: 1.5;
            font-size: 0.9rem;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .modal-input {
            width: 100%;
            padding: 10px 14px;
            background-color: #F2F2F7;
            border: 0.5px solid rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            color: #000000;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            margin-top: 0.75rem;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: #007AFF;
            background-color: #FFFFFF;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-shrink: 0;
        }
        
        .sidebar-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #8E8E93;
            letter-spacing: 0.5px;
        }
        
        .history-count {
            font-size: 0.75rem;
            color: #8E8E93;
            background-color: #F2F2F7;
            padding: 3px 8px;
            border-radius: 10px;
            min-width: 24px;
            text-align: center;
        }
        
        .title-generating {
            opacity: 0.7;
            font-style: italic;
            color: #8E8E93;
        }
        
        .title-generating::after {
            content: '...';
            animation: ellipsis 1.5s infinite;
        }
        
        @keyframes ellipsis {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        
        /* iOS Style Toast */
        .toast {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 122, 255, 0.3);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 8px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: calc(100vw - 32px);
            backdrop-filter: blur(10px);
            border: 0.5px solid rgba(255, 255, 255, 0.2);
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast-error {
            background: linear-gradient(135deg, #FF3B30 0%, #D70015 100%);
            box-shadow: 0 8px 24px rgba(255, 59, 48, 0.3);
        }
        
        .toast-warning {
            background: linear-gradient(135deg, #FF9500 0%, #FF5E3A 100%);
            box-shadow: 0 8px 24px rgba(255, 149, 0, 0.3);
        }
        
        .toast-success {
            background: linear-gradient(135deg, #34C759 0%, #2AA44F 100%);
            box-shadow: 0 8px 24px rgba(52, 199, 89, 0.3);
        }
        
        .close-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            cursor: pointer;
            padding: 3px;
            border-radius: 6px;
            transition: all 0.2s;
            outline: none;
            flex-shrink: 0;
        }
        
        .close-btn:hover {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Sidebar Toggle Button */
        .sidebar-toggle-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: #007AFF;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            outline: none;
            width: 34px;
            height: 34px;
            transition: all 0.2s;
        }
        
        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }
        
        .sidebar-toggle-btn i {
            font-size: 0.95rem;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 260px;
            }
            
            .suggestions-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
            
            .message-content {
                max-width: 80%;
            }
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 0.6rem 0.75rem;
                height: 56px;
            }
            
            .logo span {
                display: none;
            }
            
            .sidebar-toggle-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .header-actions .btn span {
                display: none;
            }
            
            .header-actions .btn {
                padding: 6px 10px;
            }
            
            .sidebar {
                position: fixed;
                top: 56px;
                left: 0;
                width: 280px;
                height: calc(100vh - 56px);
                z-index: 90;
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border-right: none;
                border-top: 0.5px solid rgba(0, 0, 0, 0.1);
                background-color: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            .container {
                position: relative;
            }
            
            .welcome-section {
                padding: 0.75rem;
            }
            
            .welcome-title {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
            }
            
            .welcome-subtitle {
                font-size: 0.8rem;
                margin-bottom: 1.25rem;
                padding: 0 0.5rem;
            }
            
            .suggestions-grid {
                grid-template-columns: 1fr;
                gap: 0.6rem;
                padding: 0 0.25rem;
            }
            
            .suggestion-card {
                padding: 0.9rem;
                min-height: 90px;
            }
            
            .suggestion-title {
                font-size: 0.85rem;
                gap: 6px;
            }
            
            .suggestion-desc {
                font-size: 0.75rem;
                -webkit-line-clamp: 2;
            }
            
            .chat-messages {
                padding: 0.75rem;
            }
            
            .message {
                padding: 0.4rem 0;
            }
            
            .message-content {
                max-width: 88%;
            }
            
            .message-text {
                font-size: 0.9rem;
                padding: 8px 12px;
            }
            
            .message-text pre {
                padding: 8px;
                font-size: 0.8rem;
            }
            
            .message-info {
                font-size: 0.65rem;
            }
            
            /* PERBAIKAN POSISI INPUT CHAT UNTUK MOBILE */
            .chat-input-container {
                padding: 0.8rem 0.75rem;
                padding-bottom: max(0.8rem, env(safe-area-inset-bottom, 0.8rem));
                background-color: #FFFFFF;
                border-top: 0.5px solid rgba(0, 0, 0, 0.1);
                position: sticky;
                bottom: 0;
                z-index: 80;
            }
            
            .chat-input {
                font-size: 0.9rem;
                padding: 10px 14px;
                min-height: 38px;
                border-radius: 18px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            }
            
            .send-button, .image-generate-button {
                width: 38px;
                height: 38px;
                margin-bottom: 0;
                box-shadow: 0 3px 10px rgba(0, 122, 255, 0.25);
            }
            
            .dropdown-menu {
                min-width: 160px;
                left: 0;
                right: auto;
                bottom: 100%;
                margin-bottom: 10px;
            }
            
            .sub-dropdown-menu {
                left: 100%;
                right: auto;
            }
            
            /* Adjust marquee animation for mobile */
            .history-item-text.marquee {
                animation: marquee 8s linear infinite;
            }
            
            @keyframes marquee {
                0% {
                    transform: translateX(0);
                }
                100% {
                    transform: translateX(calc(-100% + 80px));
                }
            }
            
            .input-footer {
                font-size: 0.65rem;
                margin-top: 0.8rem;
                padding: 0 0.25rem;
                line-height: 1.3;
            }
            
            .modal-content {
                padding: 1.25rem;
                margin: 0.75rem;
            }
            
            .modal-title {
                font-size: 1rem;
            }
            
            .btn {
                padding: 7px 10px;
                font-size: 0.8rem;
            }
            
            .toast {
                bottom: max(12px, env(safe-area-inset-bottom, 12px));
                right: 12px;
                left: 12px;
                max-width: calc(100vw - 24px);
                padding: 8px 14px;
                z-index: 1100;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 0.5rem;
                height: 52px;
            }
            
            .sidebar {
                top: 52px;
                height: calc(100vh - 52px);
            }
            
            .welcome-section {
                padding: 0.5rem;
            }
            
            .welcome-title {
                font-size: 1.1rem;
            }
            
            .welcome-subtitle {
                font-size: 0.75rem;
                margin-bottom: 1rem;
            }
            
            .suggestions-grid {
                gap: 0.5rem;
            }
            
            .suggestion-card {
                padding: 0.8rem;
                min-height: 85px;
            }
            
            .suggestion-title {
                font-size: 0.8rem;
            }
            
            .suggestion-desc {
                font-size: 0.7rem;
                -webkit-line-clamp: 2;
            }
            
            .chat-messages {
                padding: 0.5rem;
                padding-bottom: 1rem;
            }
            
            .message {
                padding: 0.3rem 0;
            }
            
            .message-content {
                max-width: 90%;
            }
            
            .message-text {
                font-size: 0.85rem;
                padding: 7px 11px;
            }
            
            .message-text pre {
                padding: 7px;
                font-size: 0.75rem;
            }
            
            .message-text img.generated-image {
                max-height: 250px;
            }
            
            /* PERBAIKAN TAMBAHAN UNTUK INPUT DI MOBILE KECIL */
            .chat-input-container {
                padding: 0.7rem 0.5rem;
                padding-bottom: max(0.7rem, env(safe-area-inset-bottom, 0.7rem));
            }
            
            .input-wrapper {
                gap: 8px;
            }
            
            .chat-input {
                font-size: 0.85rem;
                padding: 8px 12px;
                min-height: 36px;
            }
            
            .send-button, .image-generate-button {
                width: 36px;
                height: 36px;
            }
            
            .send-button i, .image-generate-button i {
                font-size: 0.85rem;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .history-item {
                padding: 8px 10px;
            }
            
            .dropdown-menu {
                min-width: 140px;
            }
            
            .sub-dropdown-menu {
                min-width: 120px;
            }
            
            /* Adjust marquee animation for small mobile */
            .history-item-text.marquee {
                animation: marquee 6s linear infinite;
            }
            
            @keyframes marquee {
                0% {
                    transform: translateX(0);
                }
                100% {
                    transform: translateX(calc(-100% + 60px));
                }
            }
            
            .input-footer {
                font-size: 0.6rem;
                margin-top: 0.7rem;
                line-height: 1.4;
            }
        }
        
        @media (max-width: 320px) {
            .header-actions {
                gap: 3px;
            }
            
            .header-actions .btn {
                padding: 5px 7px;
            }
            
            /* PENYESUAIAN TAMBAHAN UNTUK INPUT DI LAYAR SANGAT KECIL */
            .chat-input-container {
                padding: 0.6rem 0.4rem;
                padding-bottom: max(0.6rem, env(safe-area-inset-bottom, 0.6rem));
            }
            
            .chat-input {
                font-size: 0.8rem;
                padding: 7px 10px;
                min-height: 34px;
            }
            
            .message-text {
                font-size: 0.8rem;
                padding: 6px 10px;
            }
            
            .suggestion-card {
                padding: 0.7rem;
                min-height: 80px;
            }
            
            .send-button, .image-generate-button {
                width: 34px;
                height: 34px;
            }
        }
        
        /* Landscape Mode */
        @media (max-height: 600px) and (orientation: landscape) {
            .header {
                height: 50px;
                padding: 0.5rem 0.75rem;
            }
            
            .sidebar {
                top: 50px;
                height: calc(100vh - 50px);
            }
            
            .welcome-section {
                padding: 0.5rem;
            }
            
            .suggestions-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .suggestion-card {
                padding: 0.75rem;
                min-height: 80px;
            }
            
            /* PENYESUAIAN UNTUK LANDSCAPE MODE */
            .chat-input-container {
                padding: 0.5rem;
                padding-bottom: max(0.5rem, env(safe-area-inset-bottom, 0.5rem));
            }
            
            .chat-input {
                min-height: 34px;
                padding: 6px 12px;
                font-size: 0.85rem;
            }
            
            .send-button, .image-generate-button {
                width: 34px;
                height: 34px;
            }
            
            .welcome-title {
                font-size: 1rem;
                margin-bottom: 0.4rem;
            }
            
            .welcome-subtitle {
                font-size: 0.7rem;
                margin-bottom: 0.8rem;
            }
            
            .input-footer {
                font-size: 0.6rem;
                margin-top: 0.6rem;
            }
        }
        
        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #000000;
                color: #FFFFFF;
            }
            
            .header {
                background-color: rgba(28, 28, 30, 0.8);
                border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
            }
            
            .sidebar {
                background-color: rgba(28, 28, 30, 0.98);
                border-right: 0.5px solid rgba(255, 255, 255, 0.1);
            }
            
            .history-item {
                background-color: rgba(44, 44, 46, 0.8);
                border-color: rgba(255, 255, 255, 0.05);
            }
            
            .history-item:hover {
                background-color: rgba(58, 58, 60, 0.8);
            }
            
            .history-item.active {
                background-color: rgba(10, 132, 255, 0.2);
                border-color: #0A84FF;
            }
            
            .main-content {
                background-color: #000000;
            }
            
            /* DARK MODE UNTUK CHAT INPUT CONTAINER */
            .chat-input-container {
                background-color: rgba(28, 28, 30, 0.95);
                border-top: 0.5px solid rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(20px);
            }
            
            .chat-input {
                background-color: rgba(44, 44, 46, 0.9);
                color: #FFFFFF;
                border-color: rgba(255, 255, 255, 0.15);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            }
            
            .chat-input:focus {
                background-color: rgba(58, 58, 60, 0.9);
                border-color: #0A84FF;
            }
            
            .message.ai .message-text {
                background-color: rgba(44, 44, 46, 0.8);
                color: #FFFFFF;
                border-color: rgba(255, 255, 255, 0.1);
            }
            
            .message-text pre {
                background-color: #1e1e1e;
                border-color: rgba(255, 255, 255, 0.1);
            }
            
            .message-text code:not(pre code) {
                background-color: rgba(44, 44, 46, 0.8);
            }
            
            .suggestion-card {
                background-color: rgba(44, 44, 46, 0.8);
                border-color: rgba(255, 255, 255, 0.05);
            }
            
            .suggestion-card:hover {
                background-color: rgba(58, 58, 60, 0.8);
            }
            
            .modal-content {
                background-color: rgba(44, 44, 46, 0.98);
                border-color: rgba(255, 255, 255, 0.1);
            }
            
            .modal-input {
                background-color: rgba(58, 58, 60, 0.8);
                color: #FFFFFF;
                border-color: rgba(255, 255, 255, 0.1);
            }
            
            .modal-input:focus {
                background-color: rgba(72, 72, 74, 0.8);
            }
            
            .history-count {
                background-color: rgba(58, 58, 60, 0.8);
                color: #8E8E93;
            }
            
            .welcome-title {
                color: #FFFFFF;
            }
            
            .welcome-subtitle {
                color: #8E8E93;
            }
            
            .suggestion-title {
                color: #FFFFFF;
            }
            
            .suggestion-desc {
                color: #8E8E93;
            }
            
            .sidebar-title {
                color: #8E8E93;
            }
            
            .modal-title {
                color: #FFFFFF;
            }
            
            .modal-body {
                color: #8E8E93;
            }
            
            .input-footer {
                color: #8E8E93;
            }
            
            .message-action-btn:hover {
                background-color: rgba(58, 58, 60, 0.8);
            }
            
            .more-actions-btn {
                color: #8E8E93;
            }
            
            .more-actions-btn:hover {
                background-color: rgba(255, 255, 255, 0.1);
                color: #FF453A;
            }
            
            .history-item.active .more-actions-btn {
                background-color: rgba(10, 132, 255, 0.2);
                color: #0A84FF;
            }
            
            .history-item.active .more-actions-btn:hover {
                background-color: rgba(255, 69, 58, 0.1);
                color: #FF453A;
            }
            
            .delete-all-btn {
                background-color: rgba(255, 69, 58, 0.1);
                color: #FF453A;
            }
            
            .delete-all-btn:hover {
                background-color: rgba(255, 69, 58, 0.15);
            }
            
            /* Dark mode gradient adjustments */
            .btn-primary {
                background: linear-gradient(135deg, #0A84FF 0%, #0066CC 100%);
            }
            
            .new-chat-btn {
                background: linear-gradient(135deg, #0A84FF 0%, #0066CC 100%);
            }
            
            .message.user .message-avatar {
                background: linear-gradient(135deg, #0A84FF 0%, #0066CC 100%);
            }
            
            .message.ai .message-avatar {
                background: linear-gradient(135deg, #32D74B 0%, #2AA44F 100%);
            }
            
            .send-button {
                background: linear-gradient(135deg, #0A84FF 0%, #0066CC 100%);
            }
            
            .message.user .message-text {
                background: linear-gradient(135deg, #0A84FF 0%, #0066CC 100%);
            }
            
            .toast {
                background: linear-gradient(135deg, #0A84FF 0%, #0066CC 100%);
            }
            
            /* Dropdown dark mode */
            .dropdown-menu {
                background-color: rgba(44, 44, 46, 0.98);
                border-color: rgba(255, 255, 255, 0.1);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            }
            
            .dropdown-item {
                color: #FFFFFF;
            }
            
            .dropdown-item:hover {
                background-color: rgba(58, 58, 60, 0.8);
            }
            
            .dropdown-item.active {
                background-color: rgba(10, 132, 255, 0.2);
                color: #0A84FF;
            }
            
            .sub-dropdown-menu {
                background-color: rgba(44, 44, 46, 0.98);
                border-color: rgba(255, 255, 255, 0.1);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            }
            
            .dropdown-divider {
                background-color: rgba(255, 255, 255, 0.1);
            }
            
            .model-badge {
                background-color: rgba(58, 58, 60, 0.8);
                color: #8E8E93;
            }
            
            .model-badge.active {
                background-color: rgba(10, 132, 255, 0.2);
                color: #0A84FF;
            }
            
            /* Image button dark mode */
            .image-generate-button {
                background: linear-gradient(135deg, #32D74B 0%, #2AA44F 100%);
            }
            
            .image-generate-button.active {
                background: linear-gradient(135deg, #FF9F0A 0%, #FF6B35 100%);
            }
            
            .image-info {
                background-color: rgba(255, 255, 255, 0.05);
                color: #8E8E93;
            }
            
            /* Marquee text in dark mode */
            .history-item-text.static {
                color: #FFFFFF;
            }
            
            .history-item-text.marquee {
                color: #FFFFFF;
            }
            
            /* Skeleton dark mode */
            .image-skeleton-container {
                background-color: rgba(44, 44, 46, 0.8);
            }
            
            .image-skeleton {
                background: linear-gradient(90deg, rgba(44, 44, 46, 0.8) 25%, rgba(58, 58, 60, 0.8) 50%, rgba(44, 44, 46, 0.8) 75%);
            }
        }
        
        /* Loading States */
        .loading-shimmer {
            background: linear-gradient(90deg, #F2F2F7 25%, #FFFFFF 50%, #F2F2F7 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 12px;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .history-item-text.marquee {
                animation: none !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .image-skeleton {
                animation: none !important;
            }
            
            .typing-dot {
                animation: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <button class="sidebar-toggle-btn" id="sidebarToggleBtn" aria-label="Toggle sidebar">
                <i class="fas fa-history" id="sidebarToggleIcon"></i>
            </button>
            <a href="./" class="logo">
                <div class="logo-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <span>Chat AI</span>
            </a>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="newChat()">
                <i class="fas fa-plus"></i>
                <span>New Chat</span>
            </button>
            <button class="btn btn-danger" onclick="deleteCurrentChat()">
                <i class="fas fa-trash-alt"></i>
                <span>Delete</span>
            </button>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Chat History</div>
                <div class="history-count" id="historyCount">0</div>
            </div>
            <button class="new-chat-btn" onclick="newChat()">
                <i class="fas fa-plus"></i>
                <span>New Chat</span>
            </button>
            <div class="chat-history" id="chatHistory">
                <!-- Chat history items will be added here -->
            </div>
            <div class="sidebar-footer">
                <button class="delete-all-btn" onclick="deleteAllChats()">
                    <i class="fas fa-trash-alt"></i>
                    <span>Delete All History</span>
                </button>
            </div>
        </div>
        
        <div class="main-content" id="mainContent">
            <div class="welcome-section" id="welcomeSection">
                <div class="welcome-title">
                    <i class="fas fa-robot"></i> Hello, I'm Chat AI
                </div>
                <div class="welcome-subtitle">
                    Ask me anything! I can help with explanations, code, writing, analysis, and more. Or click the image button to generate images!
                </div>
                
                <div class="suggestions-grid">
                    <div class="suggestion-card" onclick="sendSuggestion('Explain quantum computing in simple terms')">
                        <div class="suggestion-title">
                            <i class="fas fa-atom"></i>
                            <span>Explain quantum computing</span>
                        </div>
                        <div class="suggestion-desc">
                            Get a simple explanation of quantum computing concepts
                        </div>
                    </div>
                    
                    <div class="suggestion-card" onclick="sendSuggestion('Write a Python function to calculate factorial')">
                        <div class="suggestion-title">
                            <i class="fas fa-code"></i>
                            <span>Write Python code</span>
                        </div>
                        <div class="suggestion-desc">
                            Generate Python code for common programming tasks
                        </div>
                    </div>
                    
                    <div class="suggestion-card" onclick="sendSuggestion('What are the benefits of renewable energy?')">
                        <div class="suggestion-title">
                            <i class="fas fa-leaf"></i>
                            <span>Renewable energy benefits</span>
                        </div>
                        <div class="suggestion-desc">
                            Learn about advantages of renewable energy sources
                        </div>
                    </div>
                    
                    <div class="suggestion-card" onclick="sendSuggestion('Create a weekly meal plan for a vegetarian')">
                        <div class="suggestion-title">
                            <i class="fas fa-utensils"></i>
                            <span>Vegetarian meal plan</span>
                        </div>
                        <div class="suggestion-desc">
                            Get a balanced weekly meal plan for vegetarians
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be added here -->
            </div>
            
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <div class="image-dropdown">
                        <button class="image-generate-button" id="imageGenerateButton" aria-label="Generate image options">
                            <i class="fas fa-image"></i>
                        </button>
                        <div class="dropdown-menu" id="imageDropdownMenu">
                            <div class="dropdown-item sub-dropdown" id="generateImageOption">
                                <i class="fas fa-paint-brush"></i>
                                <span>Generate Image</span>
                                <span class="arrow"></span>
                                <div class="sub-dropdown-menu" id="imageModelMenu">
                                    <div class="dropdown-item" onclick="selectImageModel('imagen-v3')">
                                        <i class="fas fa-cube"></i>
                                        <span>Imagen-v3</span>
                                        <span class="model-badge" id="v3Badge">Fast</span>
                                    </div>
                                    <div class="dropdown-item active" onclick="selectImageModel('imagen-v4')">
                                        <i class="fas fa-cubes"></i>
                                        <span>Imagen-v4</span>
                                        <span class="model-badge active" id="v4Badge">Default</span>
                                    </div>
                                </div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="dropdown-item" onclick="showImageSettings()">
                                <i class="fas fa-cog"></i>
                                <span>Image Settings</span>
                            </div>
                        </div>
                    </div>
                    <textarea 
                        class="chat-input" 
                        id="messageInput" 
                        placeholder="Message Chat AI..." 
                        rows="1"
                        onkeydown="handleInputKeydown(event)"
                        oninput="autoResizeTextarea(this)"
                        aria-label="Type your message"
                    ></textarea>
                    <button class="send-button" id="sendButton" onclick="sendMessage()" aria-label="Send message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="input-footer">
                    <span>Chat AI can make mistakes. Consider checking important information.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-trash-alt"></i>
                Delete Chat
            </div>
            <div class="modal-body" id="deleteModalBody">
                <!-- Content will be filled dynamically -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">
                    Cancel
                </button>
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Image Settings Modal -->
    <div class="modal" id="imageSettingsModal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-cog"></i>
                Image Generation Settings
            </div>
            <div class="modal-body">
                <div class="setting-item">
                    <label for="imageRatioSelect">Aspect Ratio</label>
                    <select class="modal-input" id="imageRatioSelect">
                        <option value="1:1">1:1 (Square)</option>
                        <option value="3:4">3:4 (Portrait)</option>
                        <option value="4:3">4:3 (Landscape)</option>
                        <option value="16:9" selected>16:9 (Widescreen)</option>
                        <option value="9:16">9:16 (Vertical Widescreen)</option>
                    </select>
                </div>
                <div class="setting-item" style="margin-top: 1rem;">
                    <label>Selected Model: <span id="currentModelDisplay">Imagen-v4</span></label>
                    <div class="model-info" style="font-size: 0.8rem; color: #8E8E93; margin-top: 4px;">
                        <span id="modelDescription">Latest version with improved quality and details</span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeImageSettings()">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="saveImageSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage">Copied to clipboard!</span>
        <button class="close-btn" onclick="hideToast()" aria-label="Close notification">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script>
        // Konfigurasi marked untuk menggunakan Highlight.js
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {
                        console.warn('Highlight.js error:', err);
                    }
                }
                return hljs.highlightAuto(code).value;
            },
            langPrefix: 'hljs language-'
        });

        // Router untuk menangani URL hash
        class HashRouter {
            constructor() {
                this.routes = {};
                this.currentHash = '';
                this.init();
            }
            
            init() {
                window.addEventListener('hashchange', () => this.handleHashChange());
                this.handleHashChange();
            }
            
            addRoute(path, handler) {
                this.routes[path] = handler;
            }
            
            handleHashChange() {
                const hash = window.location.hash;
                
                // Ekstrak path dari hash (misal: #/chat/session_id)
                const match = hash.match(/^#\/([^\/]+)\/(.+)$/);
                
                if (match) {
                    const route = match[1];
                    const param = match[2];
                    
                    if (this.routes[route]) {
                        this.currentHash = hash;
                        this.routes[route](param);
                    } else {
                        // Default ke chat jika route tidak dikenali
                        this.navigateToChat(param);
                    }
                } else if (hash === '' || hash === '#') {
                    // Buat session baru jika tidak ada hash
                    this.navigateToNewChat();
                } else {
                    // Tangani hash yang tidak valid
                    console.warn('Invalid hash format:', hash);
                    this.navigateToNewChat();
                }
            }
            
            navigateToChat(sessionId) {
                window.location.hash = `#/chat/${sessionId}`;
            }
            
            navigateToNewChat() {
                const newSessionId = generateSessionId();
                this.navigateToChat(newSessionId);
            }
            
            getCurrentSessionId() {
                const match = this.currentHash.match(/^#\/chat\/(.+)$/);
                return match ? match[1] : null;
            }
        }

        // Generate unique session ID
        function generateSessionId() {
            const timestamp = Date.now().toString(36);
            const randomStr = Math.random().toString(36).substring(2, 9);
            return `session_${timestamp}_${randomStr}`;
        }

        // Fungsi untuk generate judul dari jawaban AI
        async function generateTitleFromAnswer(answer) {
            try {
                const systemPrompt = `Buat satu judul singkat (maksimal 5 kata) yang merangkum inti dari jawaban berikut. Aturan: * Gunakan Bahasa Indonesia * Maksimal 5 kata * Tanpa tanda baca * Tanpa emoji * Bukan kalimat lengkap * Fokus pada topik utama Jawaban: ${answer}`;
                const apiUrl = `https://api.nekolabs.web.id/text.gen/gemini/3-flash?text=${encodeURIComponent(answer)}&systemPrompt=${encodeURIComponent(systemPrompt)}`;
                
                console.log('Generating title from answer...');
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.success) {
                    console.log('Title generated:', data.result);
                    return data.result;
                } else {
                    throw new Error('Failed to generate title');
                }
            } catch (error) {
                console.error('Error generating title:', error);
                return null;
            }
        }

        // Fungsi untuk mendeteksi apakah pesan mengandung permintaan generate gambar
        function containsGenerateImageCommand(message) {
            if (!message) return false;
            
            const lowerMessage = message.toLowerCase().trim();
            
            // Daftar kata kunci untuk generate gambar
            const keywords = [
                'generate image',
                'buatkan gambar',
                'buat gambar',
                'buatkan foto',
                'buat foto',
                'generate foto',
                'buatkan ilustrasi',
                'buat ilustrasi',
                'generate ilustrasi',
                'buatkan gambar tentang',
                'buat gambar tentang',
                'generate gambar tentang',
                'buatkan foto tentang',
                'buat foto tentang',
                'generate foto tentang',
                'gambar',
                'foto',
                'ilustrasi',
                'generate',
                'buat',
                'buatkan',
                'create image',
                'create gambar',
                'create foto',
                'create ilustrasi',
                'ciptakan gambar',
                'ciptakan foto',
                'ciptakan ilustrasi',
                'produksi gambar',
                'produksi foto',
                'produksi ilustrasi'
            ];
            
            // Cek apakah pesan mengandung salah satu keyword
            for (const keyword of keywords) {
                if (lowerMessage.includes(keyword.toLowerCase())) {
                    // Cek apakah ini benar-benar permintaan generate gambar
                    // Bukan hanya kata "gambar" saja dalam konteks lain
                    if (keyword.length <= 3) {
                        // Untuk kata pendek, pastikan ini konteks generate gambar
                        const words = lowerMessage.split(' ');
                        const keywordIndex = lowerMessage.indexOf(keyword);
                        
                        // Jika keyword adalah kata pertama atau didahului dengan kata perintah
                        if (keywordIndex === 0 || 
                            lowerMessage.startsWith('tolong ') || 
                            lowerMessage.startsWith('please ') || 
                            lowerMessage.startsWith('bisa ') ||
                            lowerMessage.startsWith('mohon ') ||
                            lowerMessage.startsWith('bantu ')) {
                            return true;
                        }
                    } else {
                        // Untuk keyword panjang, langsung return true
                        return true;
                    }
                }
            }
            
            // Cek pola spesifik
            const patterns = [
                /^generate\s+/i,
                /^buat(kan)?\s+(gambar|foto|ilustrasi)/i,
                /^create\s+(image|gambar|foto|ilustrasi)/i,
                /(gambar|foto|ilustrasi)\s+(dari|tentang|of|about)\s+/i,
                /(buat|create|generate)\s+(saya|aku|me|a|an)\s+(gambar|foto|ilustrasi)/i
            ];
            
            for (const pattern of patterns) {
                if (pattern.test(lowerMessage)) {
                    return true;
                }
            }
            
            return false;
        }

        // Fungsi untuk mengekstrak prompt dari pesan yang mengandung perintah generate gambar
        function extractImagePrompt(message) {
            if (!message) return '';
            
            const lowerMessage = message.toLowerCase();
            let prompt = message;
            
            // Daftar kata kunci untuk dihapus dari awal pesan
            const removeKeywords = [
                'generate image',
                'buatkan gambar',
                'buat gambar',
                'buatkan foto',
                'buat foto',
                'generate foto',
                'buatkan ilustrasi',
                'buat ilustrasi',
                'generate ilustrasi',
                'generate',
                'buat',
                'buatkan',
                'create image',
                'create gambar',
                'create foto',
                'create ilustrasi',
                'ciptakan gambar',
                'ciptakan foto',
                'ciptakan ilustrasi',
                'produksi gambar',
                'produksi foto',
                'produksi ilustrasi',
                'tolong',
                'please',
                'bisa',
                'mohon',
                'bantu',
                'saya',
                'aku',
                'dari',
                'tentang',
                'of',
                'about',
                'sebuah',
                'a',
                'an',
                'the'
            ];
            
            // Urutkan dari yang terpanjang ke terpendek untuk menghindari konflik
            removeKeywords.sort((a, b) => b.length - a.length);
            
            // Hapus kata kunci dari awal pesan
            for (const keyword of removeKeywords) {
                if (lowerMessage.startsWith(keyword.toLowerCase() + ' ')) {
                    prompt = prompt.substring(keyword.length).trim();
                    break;
                }
            }
            
            // Hapus kata "gambar", "foto", "ilustrasi" dari awal jika masih ada
            const imageWords = ['gambar', 'foto', 'ilustrasi', 'image', 'picture', 'photo'];
            for (const word of imageWords) {
                if (prompt.toLowerCase().startsWith(word + ' ')) {
                    prompt = prompt.substring(word.length).trim();
                    break;
                }
            }
            
            // Hapus tanda baca di awal
            prompt = prompt.replace(/^[.,!?;:\s]+/, '');
            
            // Kapitalisasi huruf pertama
            if (prompt.length > 0) {
                prompt = prompt.charAt(0).toUpperCase() + prompt.slice(1);
            }
            
            return prompt || 'an image';
        }

        // Fungsi untuk mendapatkan class CSS berdasarkan rasio
        function getRatioClass(ratio) {
            switch (ratio) {
                case '1:1':
                    return 'skeleton-ratio-1-1';
                case '3:4':
                    return 'skeleton-ratio-3-4';
                case '4:3':
                    return 'skeleton-ratio-4-3';
                case '16:9':
                    return 'skeleton-ratio-16-9';
                case '9:16':
                    return 'skeleton-ratio-9-16';
                default:
                    return 'skeleton-ratio-16-9';
            }
        }

        // Inisialisasi router
        const router = new HashRouter();
        
        // Session management
        let currentSessionId = null;
        let currentMessages = [];
        let allChats = JSON.parse(localStorage.getItem('chatHistory')) || {};
        let isGeneratingTitle = false;
        let isSidebarOpen = false;
        let isSidebarCollapsed = false;
        let selectedImageModel = 'imagen-v4'; // Default model
        let imageSettings = {
            ratio: '16:9'
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Setup route handler
            router.addRoute('chat', handleChatRoute);
            
            // Initialize sidebar toggle
            initSidebarToggle();
            
            // Initialize dropdowns
            initDropdowns();
            
            // Focus on input
            document.getElementById('messageInput').focus();
            
            // Load chat history from localStorage
            loadChatHistory();
            
            // Handle window resize
            window.addEventListener('resize', handleResize);
            handleResize();
            
            // Initialize dark mode detection
            initDarkMode();
            
            // Load sidebar state from localStorage
            const savedSidebarState = localStorage.getItem('sidebarCollapsed');
            if (savedSidebarState === 'true') {
                toggleSidebar();
            }
            
            // Load image settings from localStorage
            const savedImageSettings = localStorage.getItem('imageSettings');
            if (savedImageSettings) {
                imageSettings = JSON.parse(savedImageSettings);
                updateImageSettingsUI();
            }
            
            // Load selected model from localStorage
            const savedModel = localStorage.getItem('selectedImageModel');
            if (savedModel) {
                selectedImageModel = savedModel;
                updateSelectedModelUI();
            }
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                // Close image dropdown when clicking outside
                if (!e.target.closest('.image-dropdown')) {
                    closeImageDropdown();
                }
            });
            
            // Close dropdowns with escape key
            document.addEventListener('keydown', function(e) {
                // Close image dropdown with escape key
                if (e.key === 'Escape') {
                    closeImageDropdown();
                }
            });
        });
        
        // Initialize sidebar toggle
        function initSidebarToggle() {
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
            
            sidebarToggleBtn.addEventListener('click', toggleSidebar);
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && isSidebarOpen) {
                    if (!sidebar.contains(e.target) && !sidebarToggleBtn.contains(e.target)) {
                        toggleSidebar();
                    }
                }
            });
            
            // Handle escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && isSidebarOpen && window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        }
        
        // Initialize dropdowns
        function initDropdowns() {
            const imageGenerateButton = document.getElementById('imageGenerateButton');
            const imageDropdownMenu = document.getElementById('imageDropdownMenu');
            
            // Toggle image dropdown
            imageGenerateButton.addEventListener('click', function(e) {
                e.stopPropagation();
                imageDropdownMenu.classList.toggle('show');
            });
            
            // Prevent sub-dropdown from closing when clicking inside
            document.getElementById('generateImageOption').addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            document.getElementById('imageModelMenu').addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // Close image dropdown
        function closeImageDropdown() {
            const imageDropdownMenu = document.getElementById('imageDropdownMenu');
            imageDropdownMenu.classList.remove('show');
        }
        
        // Toggle sidebar visibility
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
            
            isSidebarCollapsed = !isSidebarCollapsed;
            
            if (window.innerWidth > 768) {
                // Desktop behavior
                if (isSidebarCollapsed) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('full-width');
                    sidebarToggleIcon.className = 'fas fa-bars';
                } else {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('full-width');
                    sidebarToggleIcon.className = 'fas fa-history';
                }
            } else {
                // Mobile behavior
                if (isSidebarCollapsed) {
                    sidebar.classList.remove('active');
                    sidebarToggleIcon.className = 'fas fa-bars';
                    isSidebarOpen = false;
                } else {
                    sidebar.classList.add('active');
                    sidebarToggleIcon.className = 'fas fa-times';
                    isSidebarOpen = true;
                }
            }
            
            // Save state to localStorage
            localStorage.setItem('sidebarCollapsed', isSidebarCollapsed);
        }
        
        // Handle window resize
        function handleResize() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
            const welcomeSection = document.getElementById('welcomeSection');
            
            if (window.innerWidth > 768) {
                // Desktop: restore saved state
                const savedSidebarState = localStorage.getItem('sidebarCollapsed');
                if (savedSidebarState === 'true') {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('full-width');
                    sidebarToggleIcon.className = 'fas fa-bars';
                    isSidebarCollapsed = true;
                } else {
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('full-width');
                    sidebarToggleIcon.className = 'fas fa-history';
                    isSidebarCollapsed = false;
                }
                
                // Reset mobile styles
                sidebar.classList.remove('active');
                sidebar.style.transform = '';
                isSidebarOpen = false;
                
                // Ensure welcome section is scrollable on desktop if needed
                welcomeSection.style.overflowY = 'auto';
            } else {
                // Mobile: auto-close sidebar
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('full-width');
                
                if (isSidebarOpen) {
                    sidebar.classList.add('active');
                    sidebarToggleIcon.className = 'fas fa-times';
                } else {
                    sidebar.classList.remove('active');
                    sidebarToggleIcon.className = 'fas fa-bars';
                }
                
                // Ensure welcome section can scroll on mobile
                welcomeSection.style.overflowY = 'auto';
                welcomeSection.style.maxHeight = 'calc(100vh - 120px)'; // Account for header and input
            }
            
            // Adjust suggestions grid for very small screens
            if (window.innerWidth < 400) {
                document.querySelector('.suggestions-grid').style.gridTemplateColumns = '1fr';
            } else if (window.innerWidth < 600) {
                document.querySelector('.suggestions-grid').style.gridTemplateColumns = 'repeat(2, 1fr)';
            }
        }
        
        // Initialize dark mode
        function initDarkMode() {
            const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
            
            // Initial check
            if (darkModeMediaQuery.matches) {
                document.body.classList.add('dark-mode');
            }
            
            // Listen for changes
            darkModeMediaQuery.addEventListener('change', (e) => {
                if (e.matches) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            });
        }
        
        // Handle chat route
        function handleChatRoute(sessionId) {
            currentSessionId = sessionId;
            
            // Close sidebar on mobile when navigating
            if (window.innerWidth <= 768 && isSidebarOpen) {
                toggleSidebar();
            }
            
            // Close image dropdown
            closeImageDropdown();
            
            // Load messages untuk session ini
            if (allChats[sessionId] && allChats[sessionId].messages && allChats[sessionId].messages.length > 0) {
                currentMessages = allChats[sessionId].messages;
                displayMessages();
                document.getElementById('mainContent').classList.add('chat-active');
            } else {
                // Chat kosong, tampilkan welcome screen
                currentMessages = [];
                document.getElementById('mainContent').classList.remove('chat-active');
                
                // Jangan simpan chat kosong di history
                // Hapus dari allChats jika ada
                if (allChats[sessionId]) {
                    delete allChats[sessionId];
                    saveChatsToStorage();
                    loadChatHistory();
                }
            }
        }
        
        // Load and display chat history with marquee animation
        function loadChatHistory() {
            const chatHistoryEl = document.getElementById('chatHistory');
            chatHistoryEl.innerHTML = '';
            
            const sessionIds = Object.keys(allChats);
            
            // Filter hanya chat yang memiliki pesan
            const chatsWithMessages = sessionIds.filter(id => 
                allChats[id] && allChats[id].messages && allChats[id].messages.length > 0
            );
            
            // Update history count
            document.getElementById('historyCount').textContent = chatsWithMessages.length;
            
            if (chatsWithMessages.length === 0) {
                chatHistoryEl.innerHTML = '<div class="empty-state">No chat history</div>';
                return;
            }
            
            // Sort by timestamp (newest first)
            chatsWithMessages.sort((a, b) => {
                return allChats[b].timestamp - allChats[a].timestamp;
            });
            
            chatsWithMessages.forEach(sessionId => {
                const chat = allChats[sessionId];
                const historyItem = document.createElement('div');
                historyItem.className = `history-item ${sessionId === currentSessionId ? 'active' : ''}`;
                historyItem.dataset.sessionId = sessionId;
                
                // Tampilkan indikator "generating title" jika sedang dalam proses
                const titleText = chat.title || 'New Chat';
                const isGenerating = chat.generatingTitle;
                
                // Cek jika teks perlu marquee (lebih panjang dari 20 karakter)
                const needsMarquee = titleText.length > 20;
                
                historyItem.innerHTML = `
                    <div class="history-item-content">
                        <i class="fas fa-message"></i>
                        <div class="history-item-text-container">
                            ${isGenerating ? 
                                `<div class="history-item-text static title-generating">Generating title</div>` :
                                needsMarquee ? 
                                    `<div class="history-item-text static">${titleText}</div>
                                     <div class="history-item-text marquee">${titleText}</div>` :
                                    `<div class="history-item-text static">${titleText}</div>`
                            }
                        </div>
                    </div>
                    <div class="history-item-actions">
                        <button class="more-actions-btn delete-btn" onclick="deleteChat('${sessionId}', event)" aria-label="Delete chat">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                
                historyItem.onclick = (e) => {
                    // Jangan navigasi jika klik pada tombol actions
                    if (!e.target.closest('.history-item-actions')) {
                        router.navigateToChat(sessionId);
                    }
                };
                
                chatHistoryEl.appendChild(historyItem);
            });
            
            // Scroll to active item if exists
            const activeItem = chatHistoryEl.querySelector('.history-item.active');
            if (activeItem) {
                activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }
        
        // Create new chat
        function newChat() {
            // Close image dropdown
            closeImageDropdown();
            
            router.navigateToNewChat();
        }
        
        // Delete current chat
        function deleteCurrentChat() {
            if (!currentSessionId || !allChats[currentSessionId]) {
                showToast('No chat to delete', true);
                return;
            }
            
            showDeleteModal(currentSessionId, allChats[currentSessionId].title || 'Current Chat', true);
        }
        
        // Delete specific chat
        function deleteChat(sessionId, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            if (!allChats[sessionId]) return;
            
            // Close image dropdown
            closeImageDropdown();
            
            const chatTitle = allChats[sessionId].title || 'Chat';
            showDeleteModal(sessionId, chatTitle, sessionId === currentSessionId);
        }
        
        // Delete all chats
        function deleteAllChats() {
            const sessionIds = Object.keys(allChats);
            const chatsWithMessages = sessionIds.filter(id => 
                allChats[id] && allChats[id].messages && allChats[id].messages.length > 0
            );
            
            if (chatsWithMessages.length === 0) {
                showToast('No chats to delete', true);
                return;
            }
            
            // Close image dropdown
            closeImageDropdown();
            
            showDeleteAllModal(chatsWithMessages.length);
        }
        
        // Show delete modal
        function showDeleteModal(sessionId, chatTitle, isCurrentChat) {
            const modalBody = document.getElementById('deleteModalBody');
            modalBody.innerHTML = `
                <p>Are you sure you want to delete <strong>"${chatTitle}"</strong>?</p>
                <p class="warning-text">This action cannot be undone.</p>
            `;
            
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.onclick = () => {
                performDeleteChat(sessionId, isCurrentChat);
                closeDeleteModal();
            };
            
            document.getElementById('deleteModal').classList.add('active');
        }
        
        // Show delete all modal
        function showDeleteAllModal(count) {
            const modalBody = document.getElementById('deleteModalBody');
            modalBody.innerHTML = `
                <p>Are you sure you want to delete all <strong>${count}</strong> chat${count > 1 ? 's' : ''}?</p>
                <p class="warning-text">This action cannot be undone. All chat history will be permanently deleted.</p>
            `;
            
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.onclick = () => {
                performDeleteAllChats();
                closeDeleteModal();
            };
            
            document.getElementById('deleteModal').classList.add('active');
        }
        
        // Perform delete chat
        function performDeleteChat(sessionId, isCurrentChat) {
            delete allChats[sessionId];
            saveChatsToStorage();
            
            // Jika chat yang dihapus adalah chat yang sedang aktif
            if (isCurrentChat) {
                currentMessages = [];
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('mainContent').classList.remove('chat-active');
                
                // Navigate to new chat
                router.navigateToNewChat();
            }
            
            // Update UI
            loadChatHistory();
            
            showToast('Chat deleted successfully');
        }
        
        // Perform delete all chats
        function performDeleteAllChats() {
            // Hanya hapus chat yang memiliki pesan
            const sessionIds = Object.keys(allChats);
            let deletedCount = 0;
            
            sessionIds.forEach(sessionId => {
                if (allChats[sessionId] && allChats[sessionId].messages && allChats[sessionId].messages.length > 0) {
                    delete allChats[sessionId];
                    deletedCount++;
                }
            });
            
            saveChatsToStorage();
            
            // Reset current chat jika sedang melihat chat yang dihapus
            if (currentSessionId && !allChats[currentSessionId]) {
                currentMessages = [];
                document.getElementById('chatMessages').innerHTML = '';
                document.getElementById('mainContent').classList.remove('chat-active');
                router.navigateToNewChat();
            }
            
            // Update UI
            loadChatHistory();
            
            showToast(`${deletedCount} chat${deletedCount > 1 ? 's' : ''} deleted successfully`);
        }
        
        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }
        
        // Save chats to localStorage
        function saveChatsToStorage() {
            try {
                localStorage.setItem('chatHistory', JSON.stringify(allChats));
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                // Jika localStorage penuh, coba hapus item lama
                if (e.name === 'QuotaExceededError') {
                    const keys = Object.keys(allChats);
                    if (keys.length > 10) {
                        // Hapus 5 chat tertua
                        keys.sort((a, b) => allChats[a].timestamp - allChats[b].timestamp);
                        keys.slice(0, 5).forEach(key => delete allChats[key]);
                        saveChatsToStorage(); // Coba lagi
                    }
                }
            }
        }
        
        // Send message dengan deteksi otomatis untuk generate gambar
        async function sendMessage() {
            const inputEl = document.getElementById('messageInput');
            const message = inputEl.value.trim();
            
            if (!message) return;
            
            // Clear input
            inputEl.value = '';
            inputEl.style.height = 'auto';
            
            // Close image dropdown
            closeImageDropdown();
            
            // Cek apakah pesan mengandung permintaan generate gambar
            if (containsGenerateImageCommand(message)) {
                // Ekstrak prompt dari pesan
                const imagePrompt = extractImagePrompt(message);
                
                // Tambahkan pesan user ke chat
                addMessageToChat(message, 'user');
                
                // Jika prompt kosong, minta klarifikasi
                if (!imagePrompt || imagePrompt === 'an image') {
                    addMessageToChat('What would you like me to generate? Please describe the image you want.', 'ai', new Date().toISOString(), '0ms');
                    return;
                }
                
                // Generate gambar dengan prompt yang diekstrak
                await generateImageFromPrompt(imagePrompt, message);
                return;
            }
            
            // Jika bukan permintaan generate gambar, lanjutkan dengan chat biasa
            // Add user message to chat
            addMessageToChat(message, 'user');
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Build API URL with session ID for context
                const apiUrl = `https://api.nekolabs.web.id/text.gen/gemini/3-flash?text=${encodeURIComponent(message)}&sessionId=${encodeURIComponent(currentSessionId)}`;
                
                console.log('Sending request to:', apiUrl);
                
                // Send request to API
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();
                
                // Check if response is successful
                if (data.success) {
                    // Add AI response to chat
                    addMessageToChat(data.result, 'ai', data.timestamp, data.responseTime);
                    
                    // Generate title for the chat based on AI response (only for first message)
                    if (currentMessages.length === 2) { // User message + AI response
                        generateTitleForChat(data.result, message);
                    }
                } else {
                    throw new Error('API response not successful');
                }
                
            } catch (error) {
                console.error('Error:', error);
                
                // Remove typing indicator
                removeTypingIndicator();
                
                // Show error message
                addMessageToChat('Sorry, I encountered an error. Please try again.', 'ai', new Date().toISOString(), '0ms');
            }
        }
        
        // Generate image dari prompt yang diberikan
        async function generateImageFromPrompt(prompt, originalMessage = null) {
            if (!prompt) {
                showToast('Please enter a prompt for the image', true);
                return;
            }
            
            // Show image generating indicator
            showImageGeneratingIndicator();
            
            try {
                // Encode prompt untuk URL
                const encodedPrompt = encodeURIComponent(prompt);
                
                // Tentukan API URL berdasarkan model yang dipilih
                let apiUrl;
                if (selectedImageModel === 'imagen-v3') {
                    apiUrl = `https://api.nekolabs.web.id/image.gen/imagen/3.0-fast?prompt=${encodedPrompt}&ratio=${encodeURIComponent(imageSettings.ratio)}`;
                } else {
                    // Default ke v4
                    apiUrl = `https://api.nekolabs.web.id/image.gen/imagen/4.0-fast?prompt=${encodedPrompt}&ratio=${encodeURIComponent(imageSettings.ratio)}`;
                }
                
                console.log('Generating image with URL:', apiUrl);
                console.log('Using model:', selectedImageModel);
                console.log('Settings:', imageSettings);
                console.log('Prompt:', prompt);
                
                // Send request to API
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                // Remove generating indicator
                removeImageGeneratingIndicator();
                
                // Check if response is successful
                if (data.success) {
                    // Add image to chat dengan skeleton
                    const imageUrl = data.result;
                    const timestamp = data.timestamp || new Date().toISOString();
                    const responseTime = data.responseTime || '0ms';
                    
                    // Tambahkan pesan dengan gambar dan skeleton
                    addImageMessageToChatWithSkeleton(imageUrl, prompt, timestamp, responseTime, selectedImageModel);
                    
                    // Generate title for the chat based on prompt (only for first message)
                    if (currentMessages.length === 2) { // User message + Image response
                        generateTitleForChat(prompt, originalMessage || prompt);
                    }
                    
                    // Show success toast
                    showToast(`Image generated successfully with ${selectedImageModel}!`, false, 'success');
                } else {
                    throw new Error('API response not successful');
                }
                
            } catch (error) {
                console.error('Error generating image:', error);
                
                // Remove generating indicator
                removeImageGeneratingIndicator();
                
                // Show error message
                addMessageToChat('Sorry, I encountered an error while generating the image. Please try again.', 'ai', new Date().toISOString(), '0ms');
                
                // Show error toast
                showToast('Failed to generate image. Please try again.', true);
            }
        }
        
        // Generate image dari tombol (menggunakan input field)
        async function generateImage() {
            const inputEl = document.getElementById('messageInput');
            const prompt = inputEl.value.trim();
            
            if (!prompt) {
                showToast('Please enter a prompt for the image', true);
                return;
            }
            
            // Add user message to chat
            addMessageToChat(prompt, 'user');
            
            // Clear input
            inputEl.value = '';
            inputEl.style.height = 'auto';
            
            // Close image dropdown
            closeImageDropdown();
            
            // Generate gambar
            await generateImageFromPrompt(prompt, prompt);
        }
        
        // Select image model
        function selectImageModel(model) {
            selectedImageModel = model;
            
            // Update UI
            updateSelectedModelUI();
            
            // Close dropdown
            closeImageDropdown();
            
            // Generate image if there's a prompt in the input
            const inputEl = document.getElementById('messageInput');
            const prompt = inputEl.value.trim();
            
            if (prompt) {
                // Tampilkan konfirmasi
                if (confirm(`Generate image with ${model}?`)) {
                    generateImage();
                }
            } else {
                showToast(`Image model set to ${model}. Enter a prompt and click generate.`, false, 'success');
            }
            
            // Save to localStorage
            localStorage.setItem('selectedImageModel', model);
        }
        
        // Update selected model UI
        function updateSelectedModelUI() {
            // Update badges
            const v3Badge = document.getElementById('v3Badge');
            const v4Badge = document.getElementById('v4Badge');
            const v3Item = document.querySelector('.dropdown-item[onclick*="imagen-v3"]');
            const v4Item = document.querySelector('.dropdown-item[onclick*="imagen-v4"]');
            
            // Reset all
            v3Badge.classList.remove('active');
            v3Badge.textContent = 'Fast';
            v3Item.classList.remove('active');
            
            v4Badge.classList.remove('active');
            v4Badge.textContent = 'Default';
            v4Item.classList.remove('active');
            
            // Update based on selection
            if (selectedImageModel === 'imagen-v3') {
                v3Badge.classList.add('active');
                v3Badge.textContent = 'Selected';
                v3Item.classList.add('active');
            } else {
                v4Badge.classList.add('active');
                v4Badge.textContent = 'Selected';
                v4Item.classList.add('active');
            }
            
            // Update settings modal display
            document.getElementById('currentModelDisplay').textContent = 
                selectedImageModel === 'imagen-v3' ? 'Imagen-v3' : 'Imagen-v4';
            
            document.getElementById('modelDescription').textContent = 
                selectedImageModel === 'imagen-v3' ? 
                'Previous version with good performance' : 
                'Latest version with improved quality and details';
        }
        
        // Generate title for chat
        async function generateTitleForChat(aiResponse, userMessage) {
            if (isGeneratingTitle) return;
            
            isGeneratingTitle = true;
            
            // Set flag bahwa judul sedang digenerate
            if (allChats[currentSessionId]) {
                allChats[currentSessionId].generatingTitle = true;
                saveChatsToStorage();
                loadChatHistory();
            }
            
            try {
                // Generate title dari AI response
                const generatedTitle = await generateTitleFromAnswer(aiResponse);
                
                // Jika generate title gagal, gunakan user message sebagai fallback
                let finalTitle = generatedTitle;
                if (!finalTitle) {
                    // Potong user message jika terlalu panjang
                    finalTitle = userMessage.length > 30 ? 
                        userMessage.substring(0, 30) + '...' : userMessage;
                }
                
                // Update chat title
                if (allChats[currentSessionId]) {
                    allChats[currentSessionId].title = finalTitle;
                    allChats[currentSessionId].generatingTitle = false;
                    allChats[currentSessionId].timestamp = Date.now();
                    saveChatsToStorage();
                    
                    // Update UI tanpa menampilkan notifikasi
                    loadChatHistory();
                }
            } catch (error) {
                console.error('Error generating title:', error);
                
                // Fallback: use user message as title
                if (allChats[currentSessionId]) {
                    const fallbackTitle = userMessage.length > 30 ? 
                        userMessage.substring(0, 30) + '...' : userMessage;
                    allChats[currentSessionId].title = fallbackTitle;
                    allChats[currentSessionId].generatingTitle = false;
                    allChats[currentSessionId].timestamp = Date.now();
                    saveChatsToStorage();
                    loadChatHistory();
                }
            } finally {
                isGeneratingTitle = false;
            }
        }
        
        // Send suggestion
        function sendSuggestion(suggestion) {
            document.getElementById('messageInput').value = suggestion;
            sendMessage();
        }
        
        // Add message to chat
        function addMessageToChat(message, sender, timestamp = null, responseTime = null) {
            const messageObj = {
                sender,
                content: message,
                timestamp: timestamp || new Date().toISOString(),
                responseTime,
                type: 'text'
            };
            
            currentMessages.push(messageObj);
            
            // Simpan ke chat history hanya jika ini adalah pesan pertama
            if (currentMessages.length === 1 && sender === 'user') {
                // Buat entry baru di allChats untuk chat non-kosong
                allChats[currentSessionId] = {
                    title: 'New Chat', // Temporary title
                    timestamp: Date.now(),
                    messages: [],
                    generatingTitle: false
                };
            }
            
            // Update entry di allChats jika sudah ada
            if (allChats[currentSessionId]) {
                allChats[currentSessionId].messages = currentMessages;
                allChats[currentSessionId].timestamp = Date.now();
                
                // Save to localStorage
                saveChatsToStorage();
                
                // Update UI (tapi judul mungkin masih "Generating title")
                loadChatHistory();
            }
            
            // Switch to chat view
            document.getElementById('mainContent').classList.add('chat-active');
            
            // Display messages
            displayMessages();
            
            // Scroll to bottom with smooth animation
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        // Add image message to chat dengan skeleton animation
        function addImageMessageToChatWithSkeleton(imageUrl, prompt, timestamp = null, responseTime = null, model = 'imagen-v4') {
            const messageObj = {
                sender: 'ai',
                content: imageUrl,
                prompt: prompt,
                timestamp: timestamp || new Date().toISOString(),
                responseTime,
                type: 'image',
                model: model,
                loading: true // Tambahkan flag loading
            };
            
            currentMessages.push(messageObj);
            
            // Update entry di allChats jika sudah ada
            if (allChats[currentSessionId]) {
                allChats[currentSessionId].messages = currentMessages;
                allChats[currentSessionId].timestamp = Date.now();
                
                // Save to localStorage
                saveChatsToStorage();
                
                // Update UI
                loadChatHistory();
            }
            
            // Switch to chat view
            document.getElementById('mainContent').classList.add('chat-active');
            
            // Display messages
            displayMessages();
            
            // Preload gambar dan tampilkan setelah selesai loading
            preloadImageAndReplaceSkeleton(imageUrl, prompt, timestamp, responseTime, model);
            
            // Scroll to bottom with smooth animation
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        // Preload gambar dan ganti skeleton dengan gambar asli
        function preloadImageAndReplaceSkeleton(imageUrl, prompt, timestamp, responseTime, model) {
            const img = new Image();
            
            img.onload = function() {
                // Cari pesan yang sesuai dan update status loading
                const messageIndex = currentMessages.findIndex(msg => 
                    msg.type === 'image' && 
                    msg.content === imageUrl && 
                    msg.prompt === prompt
                );
                
                if (messageIndex !== -1) {
                    // Update status loading
                    currentMessages[messageIndex].loading = false;
                    
                    // Update entry di allChats jika sudah ada
                    if (allChats[currentSessionId]) {
                        allChats[currentSessionId].messages = currentMessages;
                        saveChatsToStorage();
                    }
                    
                    // Render ulang pesan
                    displayMessages();
                    
                    // Scroll ke pesan yang baru saja selesai loading
                    setTimeout(() => {
                        const chatMessages = document.getElementById('chatMessages');
                        const messageElements = chatMessages.querySelectorAll('.message');
                        if (messageElements.length > messageIndex) {
                            messageElements[messageIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }, 100);
                }
            };
            
            img.onerror = function() {
                console.error('Failed to load image:', imageUrl);
                
                // Cari pesan yang sesuai dan update status error
                const messageIndex = currentMessages.findIndex(msg => 
                    msg.type === 'image' && 
                    msg.content === imageUrl && 
                    msg.prompt === prompt
                );
                
                if (messageIndex !== -1) {
                    // Update status loading
                    currentMessages[messageIndex].loading = false;
                    currentMessages[messageIndex].failed = true;
                    
                    // Update entry di allChats jika sudah ada
                    if (allChats[currentSessionId]) {
                        allChats[currentSessionId].messages = currentMessages;
                        saveChatsToStorage();
                    }
                    
                    // Render ulang pesan
                    displayMessages();
                }
            };
            
            // Mulai loading gambar
            img.src = imageUrl;
        }
        
        // Add image message to chat (tanpa skeleton, untuk backward compatibility)
        function addImageMessageToChat(imageUrl, prompt, timestamp = null, responseTime = null, model = 'imagen-v4') {
            const messageObj = {
                sender: 'ai',
                content: imageUrl,
                prompt: prompt,
                timestamp: timestamp || new Date().toISOString(),
                responseTime,
                type: 'image',
                model: model,
                loading: false
            };
            
            currentMessages.push(messageObj);
            
            // Update entry di allChats jika sudah ada
            if (allChats[currentSessionId]) {
                allChats[currentSessionId].messages = currentMessages;
                allChats[currentSessionId].timestamp = Date.now();
                
                // Save to localStorage
                saveChatsToStorage();
                
                // Update UI
                loadChatHistory();
            }
            
            // Switch to chat view
            document.getElementById('mainContent').classList.add('chat-active');
            
            // Display messages
            displayMessages();
            
            // Scroll to bottom with smooth animation
            setTimeout(() => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        // Display all messages
        function displayMessages() {
            const chatMessagesEl = document.getElementById('chatMessages');
            chatMessagesEl.innerHTML = '';
            
            if (currentMessages.length === 0) {
                return;
            }
            
            currentMessages.forEach((message, index) => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.sender}`;
                
                const avatarIcon = message.sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
                const senderName = message.sender === 'user' ? 'You' : 'Chat AI';
                
                // Format timestamp
                const date = new Date(message.timestamp);
                const timeDisplay = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Render konten berdasarkan tipe pesan
                let contentHtml = '';
                if (message.type === 'text') {
                    // Render markdown for AI text messages
                    if (message.sender === 'ai') {
                        contentHtml = DOMPurify.sanitize(marked.parse(message.content));
                    } else {
                        contentHtml = message.content;
                    }
                } else if (message.type === 'image') {
                    // Render gambar dengan skeleton jika masih loading
                    if (message.loading) {
                        const ratioClass = getRatioClass(imageSettings.ratio);
                        contentHtml = `
                            <div class="image-skeleton-container">
                                <div class="image-skeleton ${ratioClass}"></div>
                            </div>
                            <div class="image-info">
                                <div><strong>Prompt:</strong> ${message.prompt || 'No prompt available'}</div>
                                <div><strong>Model:</strong> ${message.model || 'Imagen-v4'}</div>
                                <div><strong>Status:</strong> <i class="fas fa-spinner fa-spin"></i> Loading image...</div>
                            </div>
                        `;
                    } else if (message.failed) {
                        contentHtml = `
                            <div class="image-skeleton-container" style="background-color: rgba(255, 59, 48, 0.1);">
                                <div style="padding: 2rem; text-align: center; color: #FF3B30;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                    <p>Failed to load image</p>
                                </div>
                            </div>
                            <div class="image-info">
                                <div><strong>Prompt:</strong> ${message.prompt || 'No prompt available'}</div>
                                <div><strong>Model:</strong> ${message.model || 'Imagen-v4'}</div>
                                <div><strong>Status:</strong> <span style="color: #FF3B30;">Failed to load</span></div>
                            </div>
                        `;
                    } else {
                        const modelInfo = message.model ? ` (${message.model})` : '';
                        contentHtml = `
                            <img src="${message.content}" alt="Generated image: ${message.prompt || 'AI Generated Image'}" class="generated-image">
                            <div class="image-info">
                                <div><strong>Prompt:</strong> ${message.prompt || 'No prompt available'}</div>
                                <div><strong>Model:</strong> ${message.model || 'Imagen-v4'}</div>
                                <div><strong>Generated:</strong> ${timeDisplay}</div>
                            </div>
                        `;
                    }
                }
                
                messageEl.innerHTML = `
                    <div class="message-avatar">
                        <i class="${avatarIcon}"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${contentHtml}</div>
                        <div class="message-info">
                            <span>${senderName}  ${timeDisplay}</span>
                            ${message.responseTime ? `<span> ${message.responseTime}</span>` : ''}
                            ${message.type === 'image' && message.model ? `<span> ${message.model}</span>` : ''}
                        </div>
                        ${message.sender === 'ai' && !message.loading ? `
                        <div class="message-actions">
                            <button class="message-action-btn" onclick="copyMessage(${index})" aria-label="Copy message">
                                <i class="fas fa-copy"></i>
                                <span>Copy</span>
                            </button>
                            ${message.type === 'image' ? `
                            <button class="message-action-btn" onclick="downloadImage('${message.content}', '${message.prompt || 'generated-image'}')" aria-label="Download image">
                                <i class="fas fa-download"></i>
                                <span>Download</span>
                            </button>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                `;
                
                chatMessagesEl.appendChild(messageEl);
            });
            
            // Apply syntax highlighting to all code blocks
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }
        
        // Show typing indicator
        function showTypingIndicator() {
            const chatMessagesEl = document.getElementById('chatMessages');
            
            const typingEl = document.createElement('div');
            typingEl.className = 'typing-indicator';
            typingEl.id = 'typingIndicator';
            
            typingEl.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            chatMessagesEl.appendChild(typingEl);
            
            // Scroll to typing indicator
            setTimeout(() => {
                chatMessagesEl.scrollTo({
                    top: chatMessagesEl.scrollHeight,
                    behavior: 'smooth'
                });
            }, 50);
        }
        
        // Remove typing indicator
        function removeTypingIndicator() {
            const typingEl = document.getElementById('typingIndicator');
            if (typingEl) {
                typingEl.remove();
            }
        }
        
        // Show image generating indicator
        function showImageGeneratingIndicator() {
            const chatMessagesEl = document.getElementById('chatMessages');
            
            const generatingEl = document.createElement('div');
            generatingEl.className = 'message ai';
            generatingEl.id = 'imageGeneratingIndicator';
            
            generatingEl.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-text">
                        <p><i class="fas fa-spinner fa-spin"></i> Generating image with ${selectedImageModel}...</p>
                    </div>
                </div>
            `;
            
            chatMessagesEl.appendChild(generatingEl);
            
            // Scroll to generating indicator
            setTimeout(() => {
                chatMessagesEl.scrollTo({
                    top: chatMessagesEl.scrollHeight,
                    behavior: 'smooth'
                });
            }, 50);
        }
        
        // Remove image generating indicator
        function removeImageGeneratingIndicator() {
            const generatingEl = document.getElementById('imageGeneratingIndicator');
            if (generatingEl) {
                generatingEl.remove();
            }
        }
        
        // Copy message to clipboard - FIXED VERSION
        function copyMessage(messageIndex) {
            const message = currentMessages[messageIndex];
            if (message) {
                let textToCopy = '';
                
                if (message.type === 'image' && message.prompt) {
                    // Untuk gambar, copy prompt
                    textToCopy = message.prompt;
                } else if (message.type === 'text') {
                    // Untuk teks AI, gunakan content asli (bukan HTML)
                    if (message.sender === 'ai') {
                        // Gunakan content asli dari objek message
                        textToCopy = message.content;
                    } else {
                        // Untuk pesan user
                        textToCopy = message.content;
                    }
                } else {
                    // Fallback
                    textToCopy = message.content || '';
                }
                
                // Hapus HTML tags jika ada
                textToCopy = textToCopy.replace(/<[^>]*>/g, '');
                
                // Decode HTML entities
                const textarea = document.createElement('textarea');
                textarea.innerHTML = textToCopy;
                textToCopy = textarea.value;
                
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showToast('Message copied to clipboard!', false, 'success');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    // Fallback method untuk browser yang tidak support clipboard API
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = textToCopy;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showToast('Message copied to clipboard!', false, 'success');
                    } catch (fallbackErr) {
                        console.error('Fallback copy failed:', fallbackErr);
                        showToast('Failed to copy message', true);
                    }
                });
            }
        }
        
        // Download image
        function downloadImage(imageUrl, filename) {
            // Buat nama file yang aman
            const safeFilename = filename.replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.png';
            
            // Buat elemen anchor untuk download
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = safeFilename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Image downloaded!', false, 'success');
        }
        
        // Show image settings modal
        function showImageSettings() {
            closeImageDropdown();
            document.getElementById('imageSettingsModal').classList.add('active');
        }
        
        // Close image settings modal
        function closeImageSettings() {
            document.getElementById('imageSettingsModal').classList.remove('active');
        }
        
        // Save image settings
        function saveImageSettings() {
            const ratioSelect = document.getElementById('imageRatioSelect');
            
            imageSettings.ratio = ratioSelect.value;
            
            // Save to localStorage
            localStorage.setItem('imageSettings', JSON.stringify(imageSettings));
            
            closeImageSettings();
            showToast('Image settings saved!', false, 'success');
        }
        
        // Update image settings UI
        function updateImageSettingsUI() {
            const ratioSelect = document.getElementById('imageRatioSelect');
            
            ratioSelect.value = imageSettings.ratio;
        }
        
        // Show toast notification
        function showToast(message, isError = false, type = '') {
            const toast = document.getElementById('toast');
            
            // Reset classes
            toast.className = 'toast';
            
            // Add appropriate class based on type
            if (type === 'success') {
                toast.classList.add('toast-success');
            } else if (isError) {
                toast.classList.add('toast-error');
            } else if (type === 'warning') {
                toast.classList.add('toast-warning');
            }
            
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                hideToast();
            }, 3000);
        }
        
        // Hide toast
        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('show');
        }
        
        // Handle Enter key in textarea
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Auto-resize textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 120);
            textarea.style.height = newHeight + 'px';
        }
        
        // Handle clicks outside modals to close them
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
        
        document.getElementById('imageSettingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageSettings();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + K untuk new chat
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                newChat();
            }
            
            // Ctrl/Cmd + L untuk focus input
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                e.preventDefault();
                document.getElementById('messageInput').focus();
            }
            
            // Ctrl/Cmd + B untuk toggle sidebar
            if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                e.preventDefault();
                toggleSidebar();
            }
            
            // Ctrl/Cmd + G untuk generate image
            if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
                e.preventDefault();
                generateImage();
            }
            
            // Escape untuk close modals dan sidebar
            if (e.key === 'Escape') {
                closeDeleteModal();
                closeImageSettings();
                
                // Close image dropdown
                closeImageDropdown();
                
                // Close sidebar on mobile
                if (window.innerWidth <= 768 && isSidebarOpen) {
                    toggleSidebar();
                }
            }
        });
        
        // Auto-save ketika tab ditutup
        window.addEventListener('beforeunload', function() {
            saveChatsToStorage();
        });
        
        // Manually trigger title generation for existing chats without titles
        function fixMissingTitles() {
            Object.keys(allChats).forEach(sessionId => {
                const chat = allChats[sessionId];
                if (chat && chat.messages && chat.messages.length > 0 && 
                    (!chat.title || chat.title === 'New Chat') && !chat.generatingTitle) {
                    
                    // Cari pesan AI pertama
                    const firstAiMessage = chat.messages.find(m => m.sender === 'ai');
                    const firstUserMessage = chat.messages.find(m => m.sender === 'user');
                    
                    if (firstAiMessage && firstUserMessage) {
                        console.log('Fixing missing title for chat:', sessionId);
                        generateTitleForChat(firstAiMessage.content, firstUserMessage.content);
                    }
                }
            });
        }
        
        // Run title fix on startup
        setTimeout(fixMissingTitles, 2000);
    </script>
</body>
</html>
